"use strict";function FriendlyChat(){this.checkSetup(),this.messageList=document.getElementById("messages"),this.messageForm=document.getElementById("message-form"),this.messageInput=document.getElementById("message"),this.submitButton=document.getElementById("submit"),this.submitImageButton=document.getElementById("submitImage"),this.imageForm=document.getElementById("image-form"),this.mediaCapture=document.getElementById("mediaCapture"),this.userPic=document.getElementById("user-pic"),this.userName=document.getElementById("user-name"),this.signInButton=document.getElementById("sign-in"),this.signOutButton=document.getElementById("sign-out"),this.signInSnackbar=document.getElementById("must-signin-snackbar"),this.messageForm.addEventListener("submit",this.saveMessage.bind(this)),this.signOutButton.addEventListener("click",this.signOut.bind(this)),this.signInButton.addEventListener("click",this.signIn.bind(this));var e=this.toggleButton.bind(this);this.messageInput.addEventListener("keyup",e),this.messageInput.addEventListener("change",e),this.submitImageButton.addEventListener("click",function(){this.mediaCapture.click()}.bind(this)),this.mediaCapture.addEventListener("change",this.saveImageMessage.bind(this)),this.initFirebase()}FriendlyChat.prototype.initFirebase=function(){this.auth=firebase.auth(),this.database=firebase.database(),this.storage=firebase.storage(),this.auth.onAuthStateChanged(this.onAuthStateChanged.bind(this))},FriendlyChat.prototype.loadMessages=function(){this.messagesRef=this.database.ref("messages"),this.messagesRef.off();var e=function(e){var t=e.val();this.displayMessage(e.key,t.name,t.text,t.photoUrl,t.imageUrl)}.bind(this);this.messagesRef.limitToLast(12).on("child_added",e),this.messagesRef.limitToLast(12).on("child_changed",e)},FriendlyChat.prototype.saveMessage=function(e){if(e.preventDefault(),this.messageInput.value&&this.checkSignedInWithMessage()){var t=this.auth.currentUser;this.messagesRef.push({name:t.displayName,text:this.messageInput.value,photoUrl:t.photoURL||"/images/profile_placeholder.png"}).then(function(){FriendlyChat.resetMaterialTextfield(this.messageInput),this.toggleButton()}.bind(this)).catch(function(e){console.error("Error writing new message to Firebase Database",e)})}},FriendlyChat.prototype.setImageUrl=function(e,t){e.startsWith("gs://")?(t.src=FriendlyChat.LOADING_IMAGE_URL,this.storage.refFromURL(e).getMetadata().then(function(e){t.src=e.downloadURLs[0]})):t.src=e},FriendlyChat.prototype.saveImageMessage=function(e){var t=e.target.files[0];if(this.imageForm.reset(),!t.type.match("image.*")){var s={message:"You can only share images",timeout:2e3};return void this.signInSnackbar.MaterialSnackbar.showSnackbar(s)}if(this.checkSignedInWithMessage()){var i=this.auth.currentUser;this.messagesRef.push({name:i.displayName,imageUrl:FriendlyChat.LOADING_IMAGE_URL,photoUrl:i.photoURL||"/images/profile_placeholder.png"}).then(function(e){var s=this.storage.ref(i.uid+"/"+Date.now()+"/"+t.name).put(t,{contentType:t.type});s.on("state_changed",null,function(e){console.error("There was an error uploading a file to Firebase Storage:",e)},function(){var t=s.snapshot.metadata.fullPath;e.update({imageUrl:this.storage.ref(t).toString()})}.bind(this))}.bind(this))}},FriendlyChat.prototype.signIn=function(){var e=new firebase.auth.GoogleAuthProvider;this.auth.signInWithPopup(e)},FriendlyChat.prototype.signOut=function(){this.auth.signOut()},FriendlyChat.prototype.onAuthStateChanged=function(e){if(e){var t=e.photoURL,s=e.displayName;this.userPic.style.backgroundImage="url("+(t||"/images/profile_placeholder.png")+")",this.userName.textContent=s,this.userName.removeAttribute("hidden"),this.userPic.removeAttribute("hidden"),this.signOutButton.removeAttribute("hidden"),this.signInButton.setAttribute("hidden","true"),this.loadMessages()}else this.userName.setAttribute("hidden","true"),this.userPic.setAttribute("hidden","true"),this.signOutButton.setAttribute("hidden","true"),this.signInButton.removeAttribute("hidden")},FriendlyChat.prototype.checkSignedInWithMessage=function(){if(this.auth.currentUser)return!0;var e={message:"You must sign-in first",timeout:2e3};return this.signInSnackbar.MaterialSnackbar.showSnackbar(e),!1},FriendlyChat.resetMaterialTextfield=function(e){e.value="",e.parentNode.MaterialTextfield.boundUpdateClassesHandler()},FriendlyChat.MESSAGE_TEMPLATE='<div class="message-container"><div class="spacing"><div class="pic"></div></div><div class="message"></div><div class="name"></div></div>',FriendlyChat.LOADING_IMAGE_URL="https://www.google.com/images/spin-32.gif",FriendlyChat.prototype.displayMessage=function(e,t,s,i,n){var a=document.getElementById(e);if(!a){var r=document.createElement("div");r.innerHTML=FriendlyChat.MESSAGE_TEMPLATE,a=r.firstChild,a.setAttribute("id",e),this.messageList.appendChild(a)}i&&(a.querySelector(".pic").style.backgroundImage="url("+i+")"),a.querySelector(".name").textContent=t;var o=a.querySelector(".message");if(s)o.textContent=s,o.innerHTML=o.innerHTML.replace(/\n/g,"<br>");else if(n){var h=document.createElement("img");h.addEventListener("load",function(){this.messageList.scrollTop=this.messageList.scrollHeight}.bind(this)),this.setImageUrl(n,h),o.innerHTML="",o.appendChild(h)}setTimeout(function(){a.classList.add("visible")},1),this.messageList.scrollTop=this.messageList.scrollHeight,this.messageInput.focus()},FriendlyChat.prototype.toggleButton=function(){this.messageInput.value?this.submitButton.removeAttribute("disabled"):this.submitButton.setAttribute("disabled","true")},FriendlyChat.prototype.checkSetup=function(){firebase&&firebase.app instanceof Function&&config?""===config.storageBucket&&window.alert("You have not enabled Firebase Storage prior to importing the firebase SDK. Make sure you go through the codelab setup instructions."):window.alert("You have not configured and imported the Firebase SDK. Make sure you go through the codelab setup instructions.")},window.friendlyChat=new FriendlyChat;