"use strict";function writeNewPost(e,t,s,n){var a={author:t,uid:e,body:n,title:s,starCount:0},o=firebase.database().ref().child("posts").push().key,l={};return l["/posts/"+o]=a,l["/user-posts/"+e+"/"+o]=a,firebase.database().ref().update(l)}function toggleStar(e,t){e.transaction(function(e){return e.stars&&e.stars[t]?(e.starCount--,e.stars[t]=null):(e.starCount++,e.stars||(e.stars={}),e.stars[t]=!0),e})}function createPostElement(e,t,s,n){var a=firebase.auth().currentUser.uid,o='<div class="post mdl-cell mdl-cell--12-col mdl-cell--6-col-tablet mdl-cell--4-col-desktop mdl-grid mdl-grid--no-spacing"><div class="mdl-card mdl-shadow--2dp"><div class="mdl-card__title mdl-color--light-blue-600 mdl-color-text--white"><h4 class="mdl-card__title-text"></h4></div><div class="header"><div><div class="avatar"></div><div class="username mdl-color-text--black"></div></div></div><span class="star"><div class="not-stared material-icons">star_border</div><div class="stared material-icons">star</div><div class="star-count">0</div></span><div class="text"></div><div class="comments-container"></div><form class="add-comment" action="#"><div class="mdl-textfield mdl-js-textfield"><input class="mdl-textfield__input new-comment" type="text"><label class="mdl-textfield__label">Comment...</label></div></form></div></div>',l=document.createElement("div");l.innerHTML=o;var i=l.firstChild;componentHandler.upgradeElements(i.getElementsByClassName("mdl-textfield")[0]);var r=i.getElementsByClassName("add-comment")[0],d=i.getElementsByClassName("new-comment")[0],c=i.getElementsByClassName("stared")[0],m=i.getElementsByClassName("not-stared")[0];i.getElementsByClassName("text")[0].innerText=s,i.getElementsByClassName("mdl-card__title-text")[0].innerText=t,i.getElementsByClassName("username")[0].innerText=n;var u=firebase.database().ref("post-comments/"+e);u.on("child_added",function(e){addCommentElement(i,e.key,e.val().text,e.val().author)}),u.on("child_changed",function(e){setCommentValues(i,e.key,e.val().text,e.val().author)}),u.on("child_removed",function(e){deleteComment(i,e.key)}),firebase.database().ref("posts/"+e+"/starCount").on("value",function(e){updateStarCount(i,e.val())}),firebase.database().ref("posts/"+e+"/stars/"+a).on("value",function(e){updateStarredByCurrentUser(i,e.val())}),r.onsubmit=function(t){t.preventDefault(),createNewComment(e,firebase.auth().currentUser.displayName,a,d.value),d.value="",d.parentElement.MaterialTextfield.boundUpdateClassesHandler()};var y=function(){var t=firebase.database().ref("/posts/"+e),s=firebase.database().ref("/user-posts/"+a+"/"+e);toggleStar(t,a),toggleStar(s,a)};return m.onclick=y,c.onclick=y,i}function createNewComment(e,t,s,n){firebase.database().ref("post-comments/"+e).push({text:n,author:t,uid:s})}function updateStarredByCurrentUser(e,t){t?(e.getElementsByClassName("stared")[0].style.display="inline-block",e.getElementsByClassName("not-stared")[0].style.display="none"):(e.getElementsByClassName("stared")[0].style.display="none",e.getElementsByClassName("not-stared")[0].style.display="inline-block")}function updateStarCount(e,t){e.getElementsByClassName("star-count")[0].innerText=t}function addCommentElement(e,t,s,n){var a=document.createElement("div");a.classList.add("comment-"+t),a.innerHTML='<span class="username"></span><span class="comment"></span>',a.getElementsByClassName("comment")[0].innerText=s,a.getElementsByClassName("username")[0].innerText=n;var o=e.getElementsByClassName("comments-container")[0];o.appendChild(a)}function setCommentValues(e,t,s,n){var a=e.getElementsByClassName("comment-"+t)[0];a.getElementsByClassName("comment")[0].innerText=s,a.getElementsByClassName("fp-username")[0].innerText=n}function deleteComment(e,t){var s=e.getElementsByClassName("comment-"+t)[0];s.parentElement.removeChild(s)}function startDatabaseQueries(){var e=firebase.auth().currentUser.uid,t=firebase.database().ref("user-posts/"+e).orderByChild("starCount"),s=firebase.database().ref("posts").limitToLast(100),n=firebase.database().ref("user-posts/"+e),a=function(e,t){e.on("child_added",function(e){var s=t.getElementsByClassName("posts-container")[0];s.insertBefore(createPostElement(e.key,e.val().title,e.val().body,e.val().author),s.firstChild)})};a(t,topUserPostsSection),a(s,userPostsSection),a(n,recentPostsSection)}function writeUserData(e,t,s){firebase.database().ref("users/"+e).set({username:t,email:s})}var messageForm=document.getElementById("message-form"),messageInput=document.getElementById("new-post-message"),titleInput=document.getElementById("new-post-title"),signInButton=document.getElementById("sign-in-button"),splashPage=document.getElementById("page-splash"),addPost=document.getElementById("add-post"),addButton=document.getElementById("add"),recentPostsSection=document.getElementById("recent-posts-list"),userPostsSection=document.getElementById("user-posts-list"),topUserPostsSection=document.getElementById("top-user-posts-list"),recentMenuButton=document.getElementById("menu-recent"),myPostsMenuButton=document.getElementById("menu-my-posts"),myTopPostsMenuButton=document.getElementById("menu-my-top-posts");window.addEventListener("load",function(){signInButton.addEventListener("click",function(){var e=new firebase.auth.GoogleAuthProvider;firebase.auth().signInWithPopup(e)}),firebase.auth().onAuthStateChanged(function(e){e?(splashPage.style.display="none",writeUserData(e.uid,e.displayName,e.email),startDatabaseQueries()):splashPage.style.display="block"}),messageForm.onsubmit=function(e){if(e.preventDefault(),messageInput.value&&titleInput.value){var t=messageInput.value;messageInput.value="";var s=firebase.auth().currentUser.uid;firebase.database().ref("/users/"+s).once("value").then(function(e){e.val().username;writeNewPost(firebase.auth().currentUser.uid,firebase.auth().currentUser.displayName,titleInput.value,t).then(function(){myPostsMenuButton.click()})})}},recentMenuButton.onclick=function(){recentPostsSection.style.display="block",userPostsSection.style.display="none",topUserPostsSection.style.display="none",addPost.style.display="none",recentMenuButton.classList.add("is-active"),myPostsMenuButton.classList.remove("is-active"),myTopPostsMenuButton.classList.remove("is-active")},myPostsMenuButton.onclick=function(){recentPostsSection.style.display="none",userPostsSection.style.display="block",topUserPostsSection.style.display="none",addPost.style.display="none",recentMenuButton.classList.remove("is-active"),myPostsMenuButton.classList.add("is-active"),myTopPostsMenuButton.classList.remove("is-active")},myTopPostsMenuButton.onclick=function(){recentPostsSection.style.display="none",userPostsSection.style.display="none",topUserPostsSection.style.display="block",addPost.style.display="none",recentMenuButton.classList.remove("is-active"),myPostsMenuButton.classList.remove("is-active"),myTopPostsMenuButton.classList.add("is-active")},addButton.onclick=function(){recentPostsSection.style.display="none",userPostsSection.style.display="none",topUserPostsSection.style.display="none",addPost.style.display="block",recentMenuButton.classList.remove("is-active"),myPostsMenuButton.classList.remove("is-active"),myTopPostsMenuButton.classList.remove("is-active"),messageInput.value="",titleInput.value=""},recentMenuButton.onclick()},!1);